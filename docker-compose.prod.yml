# Production Docker Compose for Clack Track
# Deploy with: docker compose -f docker-compose.prod.yml up -d

services:
  app:
    image: clack-track:latest
    ports:
      - '3030:3000'
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_TYPE=${DATABASE_TYPE:-mysql}
      - VESTABOARD_LOCAL_API_KEY=${VESTABOARD_LOCAL_API_KEY}
      - VESTABOARD_LOCAL_API_URL=${VESTABOARD_LOCAL_API_URL}
      - VESTABOARD_MODEL=${VESTABOARD_MODEL:-black}
      - AI_PROVIDER=${AI_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - HOME_ASSISTANT_URL=${HOME_ASSISTANT_URL:-}
      - HOME_ASSISTANT_TOKEN=${HOME_ASSISTANT_TOKEN:-}
      - WEATHER_ENTITY=${WEATHER_ENTITY:-weather.apple}
      - UPDATE_INTERVAL=${UPDATE_INTERVAL:-60}
      - TZ=${TZ:-America/Los_Angeles}
      - WEB_SERVER_ENABLED=${WEB_SERVER_ENABLED:-true}
      - WEB_SERVER_PORT=3000
      - WEB_STATIC_PATH=./dist/public
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY:-}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY:-}
      - VAPID_SUBJECT=${VAPID_SUBJECT:-}
      - WEBAUTHN_RP_ID=${WEBAUTHN_RP_ID}
      - WEBAUTHN_ORIGIN=${WEBAUTHN_ORIGIN}
    networks:
      - clack-network
      - traefik_traefik
    deploy:
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik_traefik
        - traefik.http.routers.clack-track.rule=Host(`clack.rybro.io`)
        - traefik.http.routers.clack-track.tls.certResolver=myresolver
        - traefik.http.routers.clack-track.tls.domains[0].main=*.rybro.io
        - traefik.http.services.clack-track-service.loadbalancer.server.port=3000
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://localhost:3000/').then(() => process.exit(0)).catch(() => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-clacktrack}
      - MYSQL_DATABASE=clack_track
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - clack-network
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  clack-network:
    driver: overlay
    attachable: true
  traefik_traefik:
    external: true

volumes:
  mysql_data:
