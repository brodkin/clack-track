networks:
  clack-network:
    driver: bridge

services:
  node-dev:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ..:/workspace:cached
      # Persistent Claude Code home directory (user settings, credentials, history)
      - claude-home-clack-track:/home/vscode/.claude
      # Persistent command history and config volumes
      - command-history-clack-track:/home/vscode/history
      - claude-config-clack-track:/home/vscode/.config/claude-code
      # Beads database volume (ext4 mount to support Unix sockets)
      # Fixes chmod issues on fakeowner filesystem
      - beads-db-clack-track:/workspace/.beads
    command: ['sleep', 'infinity']
    environment:
      # Claude Code environment variables
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_CODE_API_KEY=${CLAUDE_CODE_API_KEY:-${ANTHROPIC_API_KEY}}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL}
      # Node environment
      - NODE_ENV=development
    ports:
      - '3000:3000' # Application server
    working_dir: /workspace
    depends_on:
      - mysql
    networks:
      - clack-network

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: devpassword
      MYSQL_DATABASE: clack_track
    ports:
      - '3306:3306'
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - clack-network

volumes:
  # Persistent Claude Code home directory
  claude-home-clack-track:
  # Persistent command history volume
  command-history-clack-track:
  # Persistent Claude Code configuration volume
  claude-config-clack-track:
  # Persistent beads database volume (ext4 for Unix socket support)
  beads-db-clack-track:
  # MySQL database volume
  mysql-data:
