networks:
  clack-network:
    driver: bridge

services:
  node-dev:
    image: mcr.microsoft.com/devcontainers/typescript-node:20-bookworm
    volumes:
      - ..:/workspace:cached
      # Single user volume (Claude settings, history, config all persist)
      - clack-track-userdata:/home/vscode
      # Beads database volume (ext4 mount to support Unix sockets)
      - beads-db-clack-track:/workspace/.beads
    command: ['sleep', 'infinity']
    environment:
      # Claude Code environment variables
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_CODE_API_KEY=${CLAUDE_CODE_API_KEY:-${ANTHROPIC_API_KEY}}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL}
      # Node environment
      - NODE_ENV=development
    ports:
      - '3000:3000' # Application server
    working_dir: /workspace
    depends_on:
      - mysql
    networks:
      - clack-network

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: devpassword
      MYSQL_DATABASE: clack_track
    ports:
      - '3306:3306'
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - clack-network

volumes:
  # Single user data volume (Claude settings, history, config)
  clack-track-userdata:
  # Beads database volume (ext4 for Unix socket support)
  beads-db-clack-track:
  # MySQL database volume
  mysql-data:
