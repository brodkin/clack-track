# Run unit tests (fail fast)
npm run test:unit -- --bail || exit 1

# Run type checking
npm run typecheck || exit 1

# Run linting with auto-fix
npm run lint:fix || exit 1

# Run prettier on staged files
npx prettier --write --ignore-unknown .

# Re-stage files modified by prettier and linting
git add -u

# Flush beads changes after all quality gates pass
if command -v bd >/dev/null 2>&1 && [ -d .beads ]; then
    if ! bd sync --flush-only >/dev/null 2>&1; then
        echo "Error: Failed to flush bd changes to JSONL" >&2
        echo "Run 'bd sync --flush-only' manually to diagnose" >&2
        exit 1
    fi
    if [ -f .beads/issues.jsonl ]; then
        git add .beads/issues.jsonl 2>/dev/null || true
    fi
fi
