# Check if code files are staged (TypeScript, JavaScript)
CODE_PATTERN='\.(ts|tsx|js|jsx|mjs|cjs)$'
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

has_code_changes() {
    echo "$STAGED_FILES" | grep -qE "$CODE_PATTERN"
}

# Only run tests and typecheck if code files are modified
if has_code_changes; then
    echo "Code changes detected - running tests and typecheck..."

    # Run unit tests (fail fast)
    npm run test:unit -- --bail || exit 1

    # Run type checking
    npm run typecheck || exit 1
else
    echo "No code changes - skipping tests and typecheck"
fi

# Run linting with auto-fix on staged files only
STAGED_CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|mjs|cjs)$' || true)
if [ -n "$STAGED_CODE_FILES" ]; then
    echo "$STAGED_CODE_FILES" | xargs npx eslint --fix || exit 1
fi

# Run prettier on staged files only
if [ -n "$STAGED_FILES" ]; then
    echo "$STAGED_FILES" | xargs npx prettier --write --ignore-unknown 2>/dev/null || true
fi

# Re-stage files modified by prettier and linting
git add -u

# Flush beads changes after all quality gates pass
if command -v bd >/dev/null 2>&1 && [ -d .beads ]; then
    if ! bd sync --flush-only >/dev/null 2>&1; then
        echo "Error: Failed to flush bd changes to JSONL" >&2
        echo "Run 'bd sync --flush-only' manually to diagnose" >&2
        exit 1
    fi
    if [ -f .beads/issues.jsonl ]; then
        git add .beads/issues.jsonl 2>/dev/null || true
    fi
fi
